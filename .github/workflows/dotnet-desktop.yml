name: UnityBuild

on:
  schedule:
    # ë§¤ì¼ 24ì‹œê°„ë§ˆë‹¤ (UTC ê¸°ì¤€)
    - cron: "0 0 * * *"
           # â”¬ â”¬ â”¬ â”¬ â”¬
           # â”‚ â”‚ â”‚ â”‚ â”‚
           # â”‚ â”‚ â”‚ â”‚ â””â”€ Day of week (0 - 7) (0 or 7 is Sunday)
           # â”‚ â”‚ â”‚ â””â”€ Month (1 - 12)
           # â”‚ â”‚ â””â”€ Day of month (1 - 31)
           # â”‚ â””â”€ Hour (0 - 23)
           # â””â”€ Minute (0 - 59)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

permissions: write-all

env:
  RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
  
jobs:
  buildForAndroidApk:
    name: Build Android APK ğŸ›¸
    runs-on: self-hosted
    
    steps:
        # 1. í”„ë¡œì íŠ¸ ì²´í¬ì•„ì›ƒ
        - name: Check Out
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            lfs: true
  
        # 2. Library ìºì‹œ
        - name: Cache Library
          uses: actions/cache@v4
          with:
            path: Library
            key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
            restore-keys: |
              Library-

        # 3. Unity Build
        - name: Unity Build (APK)
          shell: powershell
          run: |
            $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
            $args = @(
              "-batchmode"
              "-nographics"
              "-quit"
              "-projectPath ."
              "-executeMethod BuildScript.BuildAndroid"
              "-ignore-import-errors"
            )
            & $unityExe $args
  
            # ë¹Œë“œ ê²°ê³¼ í™•ì¸
            $buildPath = "build\Android"
            $apkFile = Join-Path $buildPath "Android.apk"
            if (-Not (Test-Path $apkFile)) {
                Write-Error "APK not found. Build failed!"
                exit 1
            } else {
                Write-Host "APK generated successfully: $apkFile"
            }
  
        # 4. rclone ì„¤ì¹˜
        - name: Install rclone
          shell: powershell
          run: |
            $env:PATH += ";C:\ProgramData\chocolatey\bin"
            choco upgrade rclone -y
  
        # 5. rclone ì„¤ì •
        - name: Setup rclone config
          shell: powershell
          run: |
            $rclonePath = Join-Path $env:USERPROFILE ".config\rclone"
            if (-Not (Test-Path $rclonePath)) { New-Item -ItemType Directory -Force -Path $rclonePath }
            $env:RCLONE_CONFIG | Out-File -FilePath (Join-Path $rclonePath "rclone.conf") -Encoding ASCII
  
        # 6. APK ì´ë¦„ ë³€ê²½
        - name: Rename APK with Date & Version
          id: rename_apk
          shell: powershell
          run: |
            $DATE = Get-Date -Format "yyyyMMdd"
            $VERSION = "v1.0"  # í•„ìš” ì‹œ unity_version.txtì—ì„œ ì½ë„ë¡ ìˆ˜ì • ê°€ëŠ¥
            $buildPath = "build\Android"
            $apkFile = Join-Path $buildPath "Android.apk"
            $newName = "${DATE}_${VERSION}.apk"
            $newPath = Join-Path $buildPath $newName
            Move-Item -Path $apkFile -Destination $newPath -Force
            Write-Host "APK renamed to $newPath"
            "apk_path=$newPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ASCII
  
        # 7. Google Drive ì—…ë¡œë“œ
        - name: Upload to Google Drive
          shell: powershell
          run: |
            $apkPath = '${{ steps.rename_apk.outputs.apk_path }}'
            rclone copy $apkPath "gdrive:1bJ-xWbifFZY9KuQaPSpCi1KoLy9GQp38" -P
  
        # 8. ë¹Œë“œ í´ë” ì •ë¦¬
        - name: Cleanup Build Folder
          shell: powershell
          run: |
            if (Test-Path "build") { Remove-Item "build\*" -Recurse -Force }
