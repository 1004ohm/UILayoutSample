name: UnityBuild

on:
  schedule:
    # Îß§Ïùº 24ÏãúÍ∞ÑÎßàÎã§ (UTC Í∏∞Ï§Ä)
    - cron: "0 0 * * *"
           # ‚î¨ ‚î¨ ‚î¨ ‚î¨ ‚î¨
           # ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îÇ
           # ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ Day of week (0 - 7) (0 or 7 is Sunday)
           # ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ Month (1 - 12)
           # ‚îÇ ‚îÇ ‚îî‚îÄ Day of month (1 - 31)
           # ‚îÇ ‚îî‚îÄ Hour (0 - 23)
           # ‚îî‚îÄ Minute (0 - 59)
  workflow_dispatch: # ÏàòÎèô Ïã§ÌñâÎèÑ Í∞ÄÎä•

permissions: write-all

env:
  RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
  
jobs:
  buildForAndroidApk:
    name: Build Android APK üõ∏
    runs-on: self-hosted
    
    steps:
        # 1. ÌîÑÎ°úÏ†ùÌä∏ Ï≤¥ÌÅ¨ÏïÑÏõÉ
        - name: Check Out
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            lfs: true
  
        # 2. Library Ï∫êÏãú
        - name: Cache Library
          uses: actions/cache@v4
          with:
            path: Library
            key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
            restore-keys: |
              Library-

        # 2. Unity ÏÑ§Ïπò Í≤ΩÎ°ú ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÌïÑÏöî Ïãú ÏàòÏ†ï)
        - name: Set Unity Environment Variables
          run: |
            echo "UNITY_EXE=C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe" >> $GITHUB_ENV
            echo "PROJECT_PATH=$PWD" >> $GITHUB_ENV
            echo "OUTPUT_PATH=$PWD/build/Android/Android.apk" >> $GITHUB_ENV
            echo "JAVA_HOME=C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Data\PlaybackEngines\AndroidPlayer\OpenJDK" >> $GITHUB_ENV
            echo "ANDROID_SDK_ROOT=C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Data\PlaybackEngines\AndroidPlayer\SDK" >> $GITHUB_ENV
            echo "NDK_HOME=C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Data\PlaybackEngines\AndroidPlayer\NDK" >> $GITHUB_ENV
            echo "$JAVA_HOME\bin;$ANDROID_SDK_ROOT\platform-tools;$NDK_HOME" >> $Env:PATH

        # 3. Unity Build
        - name: Unity Build (APK)
          shell: powershell
          run: |
            $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
            $args = @(
              "-batchmode"
              "-nographics"
              "-quit"
              "-projectPath ."
              "-executeMethod BuildScript.BuildAndroid"
              "-ignore-import-errors"
            )
            & $unityExe $args
  
            # ÎπåÎìú Í≤∞Í≥º ÌôïÏù∏
            $buildPath = "build\Android"
            $apkFile = Join-Path $buildPath "Android.apk"
            if (-Not (Test-Path $apkFile)) {
                Write-Error "APK not found. Build failed!"
                exit 1
            } else {
                Write-Host "APK generated successfully: $apkFile"
            }
  
        # 4. rclone ÏÑ§Ïπò
        - name: Install rclone
          shell: powershell
          run: |
            $env:PATH += ";C:\ProgramData\chocolatey\bin"
            choco upgrade rclone -y
  
        # 5. rclone ÏÑ§Ï†ï
        - name: Setup rclone config
          shell: powershell
          run: |
            $rclonePath = Join-Path $env:USERPROFILE ".config\rclone"
            if (-Not (Test-Path $rclonePath)) { New-Item -ItemType Directory -Force -Path $rclonePath }
            $env:RCLONE_CONFIG | Out-File -FilePath (Join-Path $rclonePath "rclone.conf") -Encoding ASCII
  
        # 6. APK Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
        - name: Rename APK with Date & Version
          id: rename_apk
          shell: powershell
          run: |
            $DATE = Get-Date -Format "yyyyMMdd"
            $VERSION = "v1.0"  # ÌïÑÏöî Ïãú unity_version.txtÏóêÏÑú ÏùΩÎèÑÎ°ù ÏàòÏ†ï Í∞ÄÎä•
            $buildPath = "build\Android"
            $apkFile = Join-Path $buildPath "Android.apk"
            $newName = "${DATE}_${VERSION}.apk"
            $newPath = Join-Path $buildPath $newName
            Move-Item -Path $apkFile -Destination $newPath -Force
            Write-Host "APK renamed to $newPath"
            "apk_path=$newPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ASCII
  
        # 7. Google Drive ÏóÖÎ°úÎìú
        - name: Upload to Google Drive
          shell: powershell
          run: |
            $apkPath = '${{ steps.rename_apk.outputs.apk_path }}'
            rclone copy $apkPath "gdrive:1bJ-xWbifFZY9KuQaPSpCi1KoLy9GQp38" -P
  
        # 8. ÎπåÎìú Ìè¥Îçî Ï†ïÎ¶¨
        - name: Cleanup Build Folder
          shell: powershell
          run: |
            if (Test-Path "build") { Remove-Item "build\*" -Recurse -Force }
