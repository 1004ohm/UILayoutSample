name: UnityBuild

on:
  schedule:
    - cron: "0 0 * * *" # Îß§Ïùº 24ÏãúÍ∞ÑÎßàÎã§ (UTC Í∏∞Ï§Ä)
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

permissions: write-all

env:
  RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

jobs:
  buildForAndroidApk:
    name: Build Android APK üõ∏
    runs-on: self-hosted

    steps:
      # 1. ÌîÑÎ°úÏ†ùÌä∏ Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Check Out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # 2. Library Ï∫êÏãú
      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-

      # 3. Unity Build
      - name: Unity Build (APK)
        shell: powershell
        run: |
          $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
          $args = @(
            "-batchmode"
            "-nographics"
            "-quit"
            "-projectPath ."
            "-buildTarget Android"
            "-executeMethod BuildScript.BuildAndroid"
            "-ignore-import-errors"
          )
          & $unityExe $args

      # 4. rclone ÏÑ§Ïπò
      - name: Install rclone
        shell: powershell
        run: choco upgrade rclone -y

      # 5. rclone ÏÑ§Ï†ï
      - name: Setup rclone config
        shell: powershell
        run: |
          $rclonePath = Join-Path $env:USERPROFILE ".config\rclone"
          if (-Not (Test-Path $rclonePath)) { New-Item -ItemType Directory -Force -Path $rclonePath }
          $env:RCLONE_CONFIG | Out-File -FilePath (Join-Path $rclonePath "rclone.conf") -Encoding ASCII

      # 6. Unity Î≤ÑÏ†Ñ ÏùΩÍ∏∞
      - name: Read Unity Version
        id: version
        shell: powershell
        run: |
          $VERSION = Get-Content -Path "unity_version.txt" -Raw
          "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ASCII

      # 7. ÎπåÎìú ÌååÏùº Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Î∞è Google Drive ÏóÖÎ°úÎìú
      - name: Rename and Upload to Google Drive (APK)
        shell: powershell
        run: |
          $DATE = Get-Date -Format "yyyyMMdd"
          $VERSION = '${{ steps.version.outputs.version }}'
          $FILE_NAME = "${DATE}_${VERSION}.apk"
          Move-Item -Path "build\Android\*.apk" -Destination "build\Android\$FILE_NAME" -Force
          rclone copy "build\Android\$FILE_NAME" "gdrive:1bJ-xWbifFZY9KuQaPSpCi1KoLy9GQp38" -P

      # 8. ÎπåÎìú Ìè¥Îçî Ï†ïÎ¶¨
      - name: Cleanup Build Folder
        shell: powershell
        run: |
          if (Test-Path "build") { Remove-Item "build\*" -Recurse -Force }
