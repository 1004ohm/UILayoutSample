name: UnityBuild

on:
  schedule:
    # ë§¤ì¼ 24ì‹œê°„ë§ˆë‹¤ (UTC ê¸°ì¤€)
    - cron: "0 0 * * *"
           # â”¬ â”¬ â”¬ â”¬ â”¬
           # â”‚ â”‚ â”‚ â”‚ â”‚
           # â”‚ â”‚ â”‚ â”‚ â””â”€ Day of week (0 - 7) (0 or 7 is Sunday)
           # â”‚ â”‚ â”‚ â””â”€ Month (1 - 12)
           # â”‚ â”‚ â””â”€ Day of month (1 - 31)
           # â”‚ â””â”€ Hour (0 - 23)
           # â””â”€ Minute (0 - 59)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

permissions: write-all

env:
  RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
  
jobs:
  buildForAndroidApk:
    name: Build Android APK ğŸ›¸
    runs-on: self-hosted
    
    steps:
        # 1. í”„ë¡œì íŠ¸ ì²´í¬ì•„ì›ƒ
        - name: Check Out
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            lfs: true
  
        # 2. Library ìºì‹œ
        - name: Cache Library
          uses: actions/cache@v4
          with:
            path: Library
            key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
            restore-keys: |
              Library-

        # 3. Unity Build (ì‹¤ì‹œê°„ ë¡œê·¸)
        - name: Unity Build (APK)
          shell: powershell
          run: |
            # Unity ì‹¤í–‰ ê²½ë¡œ
            $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
  
            # Unity argument
            $args = @(
              "-batchmode"
              "-nographics"
              "-quit"
              "-projectPath ."
              "-buildTarget Android"
              "-customBuildName Android"
              "-customBuildPath build\Android\Android.apk"
              "-executeMethod BuildSettingSO.OnChange_TestBuild"
              "-ignore-import-errors"
            )
  
            # Unity ì‹¤í–‰ (ì‹¤ì‹œê°„ ì¶œë ¥)
            & $unityExe $args
  
        # 4. rclone ì„¤ì¹˜ (PATH ë“±ë¡ í›„)
        - name: Install rclone
          shell: powershell
          run: |
            # PATHì— choco ì¶”ê°€
            $env:PATH += ";C:\ProgramData\chocolatey\bin"
            choco upgrade rclone -y
  
        # 5. rclone ì„¤ì •
        - name: Setup rclone config
          shell: powershell
          run: |
            $rclonePath = Join-Path $env:USERPROFILE ".config\rclone"
            if (-Not (Test-Path $rclonePath)) { New-Item -ItemType Directory -Force -Path $rclonePath }
            $env:RCLONE_CONFIG | Out-File -FilePath (Join-Path $rclonePath "rclone.conf") -Encoding 
  
        # 5. rclone ì„¤ì •
        - name: Setup rclone config
          shell: powershell
          run: |
            $rclonePath = Join-Path $env:USERPROFILE ".config\rclone"
            if (-Not (Test-Path $rclonePath)) { New-Item -ItemType Directory -Force -Path $rclonePath }
            $env:RCLONE_CONFIG | Out-File -FilePath (Join-Path $rclonePath "rclone.conf") -Encoding ASCII
  
        # 6. Unity ë²„ì „ ì¶”ì¶œ
        - name: Export Unity Version
          shell: powershell
          run: |
            $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
            $args = "-batchmode -quit -projectPath . -executeMethod BuildInfoExporter.ExportVersion"
            Start-Process -FilePath $unityExe -ArgumentList $args -Wait
  
        # 7. Unity ë²„ì „ ì½ê¸°
        - name: Read Unity Version
          id: version
          shell: powershell
          run: |
            $VERSION = Get-Content -Path "unity_version.txt" -Raw
            "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ASCII
  
        # 8. ë¹Œë“œ íŒŒì¼ ì´ë¦„ ë³€ê²½ ë° Google Drive ì—…ë¡œë“œ
        - name: Rename and Upload to Google Drive (APK)
          shell: powershell
          run: |
            $DATE = Get-Date -Format "yyyyMMdd"
            $VERSION = '${{ steps.version.outputs.version }}'
            $FILE_NAME = "${DATE}_${VERSION}.apk"
            Move-Item -Path "build\Android\*.apk" -Destination "build\Android\$FILE_NAME" -Force
            rclone copy "build\Android\$FILE_NAME" "gdrive:1bJ-xWbifFZY9KuQaPSpCi1KoLy9GQp38" -P
  
        # 9. ë¹Œë“œ í´ë” ì •ë¦¬
        - name: Cleanup Build Folder
          shell: powershell
          run: |
            if (Test-Path "build") { Remove-Item "build\*" -Recurse -Force }
