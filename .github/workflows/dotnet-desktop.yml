name: UnityBuild

on:
  schedule:
    # ë§¤ì¼ 24ì‹œê°„ë§ˆë‹¤ (UTC ê¸°ì¤€)
    - cron: "0 0 * * *"
           # â”¬ â”¬ â”¬ â”¬ â”¬
           # â”‚ â”‚ â”‚ â”‚ â”‚
           # â”‚ â”‚ â”‚ â”‚ â””â”€ Day of week (0 - 7) (0 or 7 is Sunday)
           # â”‚ â”‚ â”‚ â””â”€ Month (1 - 12)
           # â”‚ â”‚ â””â”€ Day of month (1 - 31)
           # â”‚ â””â”€ Hour (0 - 23)
           # â””â”€ Minute (0 - 59)
    
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions: write-all

# env:
#   RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

jobs:
  buildForAndroidApk:
    name: Build Android APK ğŸ›¸
    runs-on: self-hosted

    steps:
  #     # í”„ë¡œì íŠ¸ ì²´í¬ì•„ì›ƒ
  #     - name: Check Out
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         lfs: true

  #     # Unity Library ì´ˆê¸°í™” (ì—ì…‹ DB ìƒì„±)
  #     - name: Initialize Unity Library
  #       shell: powershell
  #       run: |
  #         $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
  #         $args = @(
  #           "-batchmode",
  #           "-nographics",
  #           "-quit",
  #           "-projectPath", "${{ github.workspace }}",
  #           "-logFile", "${{ github.workspace }}\unity_init.log",
  #           "-executeMethod", "BuildScript.InitLibrary"
  #         )
      
  #         Write-Host "Initializing Unity Library..."
  #         & $unityExe $args
  #         if ($LASTEXITCODE -ne 0) {
  #           Write-Host "Unity Library Initialization Failed!"
  #           exit $LASTEXITCODE
  #         }

  #     # Library ìºì‹œ
  #     - name: Cache Library
  #       uses: actions/cache@v4
  #       with:
  #         path: Library
  #         key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
  #         restore-keys: |
  #           Library-

  #     # ì”¬ ì¡´ì¬ í™•ì¸ (Runnerì—ì„œ)
  #     - name: Verify Scenes
  #       shell: powershell
  #       run: |
  #         $scenes = @("Assets/Scenes/SampleScene.unity")
  #         foreach ($s in $scenes) {
  #           if (-not (Test-Path $s)) {
  #             Write-Error "ì”¬ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: $s"
  #             exit 1
  #           } else {
  #             Write-Host "ì”¬ ì¡´ì¬ í™•ì¸: $s"
  #           }
  #         }

  #     # Unity ë¹Œë“œ ì‹¤í–‰
  #     - name: Build Android APK
  #       shell: powershell
  #       run: |
  #         $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
  #         $args = "-batchmode -nographics -quit -projectPath `"$env:GITHUB_WORKSPACE`" -executeMethod BuildScript.BuildAndroid -logFile `"$env:GITHUB_WORKSPACE\unity_build.log`" -ignore-import-errors"
      
  #         Write-Host "Unity Build Start..."
  #         Start-Process -FilePath $unityExe -ArgumentList $args -Wait
  #         Write-Host "Unity Build Complete."

      # rclone ì„¤ì¹˜
      - name: Install rclone
        shell: powershell
        run: choco upgrade rclone -y

      # service-account.json ë³µì›
      - name: Setup service account file
        shell: powershell
        run: |
          $saPath = Join-Path $env:GITHUB_WORKSPACE "service-account.json"
          $bytes = [System.Text.Encoding]::UTF8.GetBytes('${{ secrets.SERVICE_ACCOUNT_JSON }}')
          [System.IO.File]::WriteAllBytes($saPath, $bytes)
          
      # rclone config ìƒì„±
      - name: Setup rclone config
        shell: powershell
        run: |
          $rclonePath = Join-Path $env:USERPROFILE ".config\rclone"
          if (-Not (Test-Path $rclonePath)) { New-Item -ItemType Directory -Force -Path $rclonePath }

          $rcloneConf = @"
          [gdrive_apk]
          type = drive
          scope = drive
          service_account_file = $env:GITHUB_WORKSPACE\service-account.json
          team_drive = 11EIuv5zMr8TawQle8TEKrJWffgWsCC3P
          "@

          $rcloneConf | Out-File -FilePath (Join-Path $rclonePath "rclone.conf") -Encoding UTF8

      # # Unity ë²„ì „ ì¶”ì¶œ
      # - name: Export Unity Version
      #   shell: powershell
      #   run: |
      #     $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
      #     $args = "-batchmode -quit -projectPath . -executeMethod BuildInfoExporter.ExportVersion"
      #     Start-Process -FilePath $unityExe -ArgumentList $args -Wait
      
      # Unity ë²„ì „ ì½ê¸°
      - name: Read Unity Version
        id: version
        shell: powershell
        run: |
          $VERSION = Get-Content -Path "unity_version.txt" -Raw
          "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ASCII

      # rclone ê³µìœ  ë“œë¼ì´ë¸Œ í…ŒìŠ¤íŠ¸
      - name: Test rclone Remote and Shared Drive
        shell: powershell
        run: |
          Write-Host "==== List all rclone remotes ===="
          rclone listremotes
      
          Write-Host "==== List root of shared drive (gdrive_apk) ===="
          rclone lsd gdrive_apk:

      # ë¹Œë“œ íŒŒì¼ ì´ë¦„ ë³€ê²½ ë° Google Drive ì—…ë¡œë“œ
      - name: Rename and Upload to Google Drive (APK)
        shell: powershell
        run: |
          $DATE = Get-Date -Format "yyyyMMdd"
          $VERSION = '${{ steps.version.outputs.version }}'
          $APK_PATH = Get-ChildItem "build\Android\*.apk" | Select-Object -First 1
          $FILE_NAME = "${DATE}_${VERSION}.apk"
          $DEST_PATH = "build\Android\$FILE_NAME"
          
          Move-Item -Path $APK_PATH.FullName -Destination $DEST_PATH -Force
          rclone copy $DEST_PATH "gdrive_apk:'01 í”„ë¡œì íŠ¸/03 ì•…ì‚¬í‚¤ìš°ê¸°/60 ë¹Œë“œ/APK'" -P

      # # ë¹Œë“œ í´ë” ì •ë¦¬
      # - name: Cleanup Build Folder
      #   shell: powershell
      #   run: |
      #     if (Test-Path "build") { Remove-Item "build\*" -Recurse -Force }
