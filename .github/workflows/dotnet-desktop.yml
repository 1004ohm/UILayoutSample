name: UnityBuild

on:
  schedule:
    # ë§¤ì¼ 24ì‹œê°„ë§ˆë‹¤ (UTC ê¸°ì¤€)
    - cron: "0 0 * * *"
           # â”¬ â”¬ â”¬ â”¬ â”¬
           # â”‚ â”‚ â”‚ â”‚ â”‚
           # â”‚ â”‚ â”‚ â”‚ â””â”€ Day of week (0 - 7) (0 or 7 is Sunday)
           # â”‚ â”‚ â”‚ â””â”€ Month (1 - 12)
           # â”‚ â”‚ â””â”€ Day of month (1 - 31)
           # â”‚ â””â”€ Hour (0 - 23)
           # â””â”€ Minute (0 - 59)
    
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions: write-all

# env:
#   RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

jobs:
  buildForAndroidApk:
    name: Build Android APK ğŸ›¸
    runs-on: self-hosted

    steps:
      # í”„ë¡œì íŠ¸ ì²´í¬ì•„ì›ƒ
      - name: Check Out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # Unity Library ì´ˆê¸°í™” (ì—ì…‹ DB ìƒì„±)
      - name: Initialize Unity Library
        shell: powershell
        run: |
          $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
          $args = @(
            "-batchmode",
            "-nographics",
            "-quit",
            "-projectPath", "${{ github.workspace }}",
            "-logFile", "${{ github.workspace }}\unity_init.log",
            "-executeMethod", "BuildScript.InitLibrary"
          )
      
          Write-Host "Initializing Unity Library..."
          & $unityExe $args
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Unity Library Initialization Failed!"
            exit $LASTEXITCODE
          }

      # Library ìºì‹œ
      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-

      # ì”¬ ì¡´ì¬ í™•ì¸ (Runnerì—ì„œ)
      - name: Verify Scenes
        shell: powershell
        run: |
          $scenes = @("Assets/Scenes/SampleScene.unity")
          foreach ($s in $scenes) {
            if (-not (Test-Path $s)) {
              Write-Error "ì”¬ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: $s"
              exit 1
            } else {
              Write-Host "ì”¬ ì¡´ì¬ í™•ì¸: $s"
            }
          }

      # Unity ë¹Œë“œ ì‹¤í–‰
      - name: Build Android APK
        shell: powershell
        run: |
          $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
          $args = "-batchmode -nographics -quit -projectPath `"$env:GITHUB_WORKSPACE`" -executeMethod BuildScript.BuildAndroid -logFile `"$env:GITHUB_WORKSPACE\unity_build.log`" -ignore-import-errors"
      
          Write-Host "Unity Build Start..."
          Start-Process -FilePath $unityExe -ArgumentList $args -Wait
          Write-Host "Unity Build Complete."
