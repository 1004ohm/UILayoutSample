name: UnityBuild

on:
  schedule:
    # 매일 24시간마다 (UTC 기준)
    - cron: "0 0 * * *"
           # ┬ ┬ ┬ ┬ ┬
           # │ │ │ │ │
           # │ │ │ │ └─ Day of week (0 - 7) (0 or 7 is Sunday)
           # │ │ │ └─ Month (1 - 12)
           # │ │ └─ Day of month (1 - 31)
           # │ └─ Hour (0 - 23)
           # └─ Minute (0 - 59)
    
  workflow_dispatch: # 수동 실행 가능

permissions: write-all

# env:
#   RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

jobs:
  buildForAndroidApk:
    name: Build Android APK 🛸
    runs-on: self-hosted

    steps:
      # 프로젝트 체크아웃
      - name: Check Out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      # Unity Library 초기화 (에셋 DB 생성)
      - name: Initialize Unity Library
        shell: powershell
        run: |
          $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
          $args = @(
            "-batchmode",
            "-nographics",
            "-quit",
            "-projectPath", "${{ github.workspace }}",
            "-logFile", "${{ github.workspace }}\unity_init.log",
            "-executeMethod", "BuildScript.InitLibrary"
          )
      
          Write-Host "Initializing Unity Library..."
          & $unityExe $args
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Unity Library Initialization Failed!"
            exit $LASTEXITCODE
          }

      # Library 캐시
      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-

      # 씬 존재 확인 (Runner에서)
      - name: Verify Scenes
        shell: powershell
        run: |
          $scenes = @("Assets/Scenes/SampleScene.unity")
          foreach ($s in $scenes) {
            if (-not (Test-Path $s)) {
              Write-Error "씬 파일이 존재하지 않음: $s"
              exit 1
            } else {
              Write-Host "씬 존재 확인: $s"
            }
          }

      # Unity 빌드 실행
      - name: Build Android APK
        shell: powershell
        run: |
          $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
          $args = "-batchmode -nographics -quit -projectPath `"$env:GITHUB_WORKSPACE`" -executeMethod BuildScript.BuildAndroid -logFile `"$env:GITHUB_WORKSPACE\unity_build.log`" -ignore-import-errors"
      
          Write-Host "Unity Build Start..."
          Start-Process -FilePath $unityExe -ArgumentList $args -Wait
          Write-Host "Unity Build Complete."
