name: UnityBuild

on:
  schedule:
    # Îß§Ïùº 24ÏãúÍ∞ÑÎßàÎã§ (UTC Í∏∞Ï§Ä)
    - cron: "0 0 * * *"
           # ‚î¨ ‚î¨ ‚î¨ ‚î¨ ‚î¨
           # ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îÇ
           # ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ Day of week (0 - 7) (0 or 7 is Sunday)
           # ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ Month (1 - 12)
           # ‚îÇ ‚îÇ ‚îî‚îÄ Day of month (1 - 31)
           # ‚îÇ ‚îî‚îÄ Hour (0 - 23)
           # ‚îî‚îÄ Minute (0 - 59)
  workflow_dispatch: # ÏàòÎèô Ïã§ÌñâÎèÑ Í∞ÄÎä•

permissions: write-all

env:
  RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
  
jobs:
  buildForAndroidApk:
    name: Build Android APK üõ∏
    runs-on: self-hosted
    
    steps:
        - name: Check Out
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            lfs: true
  
        - name: Cache Library
          uses: actions/cache@v4
          with:
            path: Library
            key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
            restore-keys: |
              Library-

        - name: Unity Build (APK)
          shell: powershell
          run: |
            $unityExe = "C:\Program Files\Unity\Hub\Editor\2022.3.60f1\Editor\Unity.exe"
            $projectPath = $pwd.Path
            $logFile = Join-Path $projectPath "unity_build.log"
            
            if (Test-Path "build") {
              Remove-Item "build" -Recurse -Force
            }
            
            $process = Start-Process -FilePath $unityExe -ArgumentList @(
              "-batchmode",
              "-nographics",
              "-quit",
              "-projectPath", $projectPath,
              "-executeMethod", "BuildScript.BuildAndroid",
              "-logFile", $logFile
            ) -Wait -PassThru -NoNewWindow
            
            if (Test-Path $logFile) {
              Get-Content $logFile -Tail 50
            }
            
            $expectedApk = "build\Android\Android.apk"
            if (-Not (Test-Path $expectedApk)) {
                Write-Error "APK not found"
                exit 1
            }
  
        - name: Install rclone
          shell: powershell
          run: |
            $env:PATH += ";C:\ProgramData\chocolatey\bin"
            choco upgrade rclone -y
  
        - name: Setup rclone config
          shell: powershell
          run: |
            $rclonePath = Join-Path $env:USERPROFILE ".config\rclone"
            if (-Not (Test-Path $rclonePath)) { 
              New-Item -ItemType Directory -Force -Path $rclonePath 
            }
            $env:RCLONE_CONFIG | Out-File -FilePath (Join-Path $rclonePath "rclone.conf") -Encoding ASCII
  
        - name: Rename APK with Date & Version
          id: rename_apk
          shell: powershell
          run: |
            $DATE = Get-Date -Format "yyyyMMdd"
            $VERSION = "v1.0"
            $buildPath = "build\Android"
            $apkFile = Join-Path $buildPath "Android.apk"
            $newName = "${DATE}_${VERSION}.apk"
            $newPath = Join-Path $buildPath $newName
            
            Move-Item -Path $apkFile -Destination $newPath -Force
            "apk_path=$newPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding ASCII -Append
  
        - name: Upload to Google Drive
          shell: powershell
          run: |
            $apkPath = "${{ steps.rename_apk.outputs.apk_path }}"
            rclone copy $apkPath "gdrive:1bJ-xWbifFZY9KuQaPSpCi1KoLy9GQp38" -P
  
        - name: Cleanup Build Folder
          if: always()
          shell: powershell
          run: |
            if (Test-Path "build") { 
              Remove-Item "build\*" -Recurse -Force 
            }
